<!DOCTYPE html>
<html lang="en">
    <%- include('../includes/head.ejs') %>
    <body>
        <%- include('../includes/header.ejs') %>
        <%- include('../includes/menu.ejs') %>
        <!-- 상위 부모 컨테이너 -->
        <div id="div__channel-profile-container">
            <%- include('../includes/channel-tab-box.ejs') %>
            <div class="div__user-list">
                <div id="title">
                    👍🏻 팀원 목록
                </div>
                <div class="user-inner">
                    <div id="invite-member-modal__btn" class="user__div-wrapper">
                        <!-- <button class="card" id="invite"><img src="/images/plus-icon.png"></button> -->
                        <img id="add-icon" src="/images/icons8-add-50.png">
                        <div id="invite">
                            <h2>팀원 추가</h2>
                        </div>
                    </div>
                    <%if(channel.members.length > 0) { %>
                        <% for(let member of channel.members) { %>
                            <div class="user__div-wrapper">
                                <img src="<%= member.photo %>">
                                <div class="card">
                                    <h2><%= member.name %></h2>
                                </div>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div class="user__div-wrapper">
                            <h2>팀원을 초대하세요!!</h2>
                        </div>  
                    <% } %>
                </div>
            </div>
        </div>
        <script type="module">
            import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js";

            const socket = io('http://localhost:8080');
            console.log('스크립트 소켓 가동 중!!!');

            const reqApi = async () => {
                try {
                    const name = document.getElementById('clientName').value;
                    const nicknameBox = document.getElementById('nickname');
                    const errorTag = document.getElementById('error');

                    if(name === "") {
                        console.log('비어있습니다.')
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = '함께할 팀원을 입력하세요.'
                        return;
                    }

                    const url = window.location.href;
                    const channelId = url.split('/')[4].split('?')[0];
                    console.log(channelId);
                    console.log(name);
                    const response = await fetch('http://localhost:8080/v1/user/userInfo/' + name, {
                        method: 'POST',
                        headers: {
                            'Content-Type' : 'application/json'
                        },
                        body: JSON.stringify({
                            channelId: channelId
                        })
                    });

                    const data = await response.json();
                    console.log('api응답 data: ', data);

                    if (response.status !== 200) {
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = data.error.message;
                    } else {
                        //모달창 오픈
                        document.getElementById('searchBox').classList.remove('hidden');
                        document.getElementById('resultModal').classList.remove('hidden');
                        document.getElementById('container').classList.add('hidden');
                        document.getElementById('modal').classList.add('hidden');

                        const msg = document.getElementById('msg');
                        msg.style.color = 'black';
                        msg.textContent = `${data.user.name}님을 찾았습니다.`;

                        console.log(document.getElementById('matchedClientName'));
                        const h1 = document.createElement('h1');
                        h1.textContent = data.user.name;
                        document.getElementById('matchedClientName').appendChild(h1);

                        const img = document.createElement('img');
                        img.setAttribute('src', data.user.photo);
                        document.getElementById('photo').appendChild(img);

                        const invitedUserId = document.getElementById('invitedUserId');
                        invitedUserId.setAttribute('value', data.user._id);
                        console.log(invitedUserId);

                        const form = document.getElementById('form');
                        const channelId = window.location.href.split('/')[4];
                        console.log('channelId: ', channelId);
                        // 요청 보낼 라우트 세팅
                        form.setAttribute('action', '/client/channel/invite/' + channelId);

                        console.log('프로필 로딩 완료!!!');
                    }
                } catch (err) {
                    console.log(err);
                    throw err;
                }
            }

            document.getElementById('search').addEventListener('click', reqApi);
        </script>
        <%- include('../includes/script.ejs') %>
    </body>
</html>