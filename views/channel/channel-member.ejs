<!-- This favicon was generated using the following font:

- Font Title: League Spartan
- Font Author: Copyright 2020 The League Spartan Project Authors (https://github.com/theleagueof/league-spartan)
- Font Source: http://fonts.gstatic.com/s/leaguespartan/v11/kJEnBuEW6A0lliaV_m88ja5Twtx8BWhtkDVmjZvM_oTpBMdcFguczA.ttf
- Font License: SIL Open Font License, 1.1 (http://scripts.sil.org/OFL)) -->

<!DOCTYPE html>
<html lang="en">
    <%- include('../includes/head.ejs') %>
    <body>
        <%- include('../includes/header.ejs') %>
        <%- include('../includes/menu.ejs') %>
        <%- include('../includes/loading.ejs') %>
        <!-- ìƒìœ„ ë¶€ëª¨ ì»¨í…Œì´ë„ˆ -->
        <div id="div__channel-profile-container">
            <div class="div__user-list">
                <div id="tab-box">
                    <a class="type" id="info" href="/mychannel/<%= channel._id %>?searchWord=info"> ì±„ë„ ì •ë³´ </a>
                    <a class="type" id="member" href="/mychannel/<%= channel._id %>?searchWord=member"> íŒ€ì›</a>
                    <a class="type" id="member" href="/client/channel/exit/<%= channel._id %>" style="float: right;">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>  ì±„ë„ íƒˆí‡´
                    </a>
                </div>
                <div id="title">
                    ğŸ‘ğŸ» íŒ€ì› ëª©ë¡
                </div>
                <div id="invite" class="user__div-wrapper">
                    <!-- <button class="card" id="invite"><img src="/images/plus-icon.png"></button> -->
                    <img id="add-icon" src="/images/icons8-add-50.png">
                    <div id="invite">
                        <h2>íŒ€ì› ì¶”ê°€</h2>
                    </div>
                </div>
                <%if(channel.members.length > 0) { %>
                    <% for(let member of channel.members) { %>
                        <div class="user__div-wrapper">
                            <img src="<%= member.photo %>">
                            <div class="card">
                                <h2><%= member.name %></h2>
                            </div>
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="user__div-wrapper">
                        <h2>íŒ€ì›ì„ ì´ˆëŒ€í•˜ì„¸ìš”!!</h2>
                    </div>  
                <% } %>
            </div>
        </div>

        <!-- ìœ ì € ì´ˆëŒ€ í´ë¦­ì‹œ ëª¨ë‹¬ì°½ ì˜¤í”ˆ -->
        <div class="invite-container hidden" id="container">
            <div class="invite-modal hidden" id="modal">
                <div class="box__input__invite">
                    <h1>ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</h1>
                </div>
                <div id="nickname" class="box__input__invite">
                    <input type="text" name="name" id="clientName" placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">
                    <p id="error"></p>
                </div>
                <div class="box__input__invite">
                    <span><button id="search">ê²€ìƒ‰ í•˜ê¸°</button></span>
                </div>
                <div class="box__input__invite">
                    <span class="close-modal-button__box"><button id="cancel" class="close-modal-channel">ì·¨ì†Œ</button></span>
                </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ í›„ ë³´ì¼ ê²°ê³¼ ì°½ -->
        <div class="invite-container hidden" id="searchBox">
            <div class="invite-modal hidden" id="resultModal">
                <div id="msg"></div>
                <form id="form" method="post">
                    <div class="box__input__invite" id="matchedClientName">
                        <!-- í´ë¼ì´ì–¸íŠ¸ ë‹‰ë„¤ì„ ë“¤ì–´ê°ˆ ê³³ -->
                    </div>
                    <div class="box__input__invite" id="photo">
                        <!-- ì´ë¯¸ì§€ ë“¤ì–´ê°ˆ ê³³ -->
                    </div>
                    <input type="hidden" name="invitedUserId" id="invitedUserId">
                    <div class="box__input__invite">
                        <span><button type="submit">ì´ˆëŒ€ í•˜ê¸°</button></span>
                    </div>
                </form>
                <div class="box__input__invite">
                    <span class="close-modal-button__box"><button id="cancelInvite"
                            class="close-modal-channel">ì·¨ì†Œ</button></span>
                </div>
            </div>
        </div>
                
        <script type="module">
            import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js";

            const socket = io('http://localhost:8080');
            console.log('ìŠ¤í¬ë¦½íŠ¸ ì†Œì¼“ ê°€ë™ ì¤‘!!!');

            const reqApi = async () => {
                try {
                    const name = document.getElementById('clientName').value;
                    const nicknameBox = document.getElementById('nickname');
                    const errorTag = document.getElementById('error');

                    if(name === "") {
                        console.log('ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = 'í•¨ê»˜í•  íŒ€ì›ì„ ì…ë ¥í•˜ì„¸ìš”.'
                        return;
                    }

                    const url = window.location.href;
                    const channelId = url.split('/')[4].split('?')[0];
                    console.log(channelId);
                    console.log(name);
                    const response = await fetch('http://localhost:8080/v1/user/userInfo/' + name, {
                        method: 'POST',
                        headers: {
                            'Content-Type' : 'application/json'
                        },
                        body: JSON.stringify({
                            channelId: channelId
                        })
                    });

                    const data = await response.json();
                    console.log('apiì‘ë‹µ data: ', JSON.stringify(data));

                    if (response.status !== 200) {
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = data.error.message;
                    } else {
                        //ëª¨ë‹¬ì°½ ì˜¤í”ˆ
                        document.getElementById('searchBox').classList.remove('hidden');
                        document.getElementById('resultModal').classList.remove('hidden');
                        document.getElementById('container').classList.add('hidden');
                        document.getElementById('modal').classList.add('hidden');

                        const msg = document.getElementById('msg');
                        msg.style.color = 'black';
                        msg.textContent = `${data.user.name}ë‹˜ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;

                        console.log(document.getElementById('matchedClientName'));
                        const h1 = document.createElement('h1');
                        h1.textContent = data.user.name;
                        document.getElementById('matchedClientName').appendChild(h1);

                        const img = document.createElement('img');
                        img.setAttribute('src', data.user.photo);
                        document.getElementById('photo').appendChild(img);

                        const invitedUserId = document.getElementById('invitedUserId');
                        invitedUserId.setAttribute('value', data.user._id);
                        console.log(invitedUserId);

                        const form = document.getElementById('form');
                        const channelId = window.location.href.split('/')[4];
                        console.log('channelId: ', channelId);
                        // ìš”ì²­ ë³´ë‚¼ ë¼ìš°íŠ¸ ì„¸íŒ…
                        form.setAttribute('action', '/client/channel/invite/' + channelId);

                        console.log('í”„ë¡œí•„ ë¡œë”© ì™„ë£Œ!!!');
                    }
                } catch (err) {
                    console.log(err);
                    throw err;
                }
            }

            document.getElementById('search').addEventListener('click', reqApi);
        </script>
        <%- include('../includes/script.ejs') %>
    </body>
</html>