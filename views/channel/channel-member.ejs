<!-- This favicon was generated using the following font:

- Font Title: League Spartan
- Font Author: Copyright 2020 The League Spartan Project Authors (https://github.com/theleagueof/league-spartan)
- Font Source: http://fonts.gstatic.com/s/leaguespartan/v11/kJEnBuEW6A0lliaV_m88ja5Twtx8BWhtkDVmjZvM_oTpBMdcFguczA.ttf
- Font License: SIL Open Font License, 1.1 (http://scripts.sil.org/OFL)) -->

<!DOCTYPE html>
<html lang="en">
    <%- include('../includes/head.ejs') %>
    <body>
        <%- include('../includes/header.ejs') %>
        <%- include('../includes/menu.ejs') %>
        <%- include('../includes/loading.ejs') %>
        <!-- 상위 부모 컨테이너 -->
        <div id="div__channel-profile-container">
            <div class="div__user-list">
                <div id="tab-box">
                    <a class="type" id="info" href="/mychannel/<%= channel._id %>?searchWord=info"> 채널 정보 </a>
                    <a class="type" id="member" href="/mychannel/<%= channel._id %>?searchWord=member"> 팀원</a>
                    <a class="type" id="member" href="/client/channel/exit/<%= channel._id %>" style="float: right;">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>  채널 탈퇴
                    </a>
                </div>
                <div id="title">
                    👍🏻 팀원 목록
                </div>
                <div id="invite" class="user__div-wrapper">
                    <!-- <button class="card" id="invite"><img src="/images/plus-icon.png"></button> -->
                    <img id="add-icon" src="/images/icons8-add-50.png">
                    <div id="invite">
                        <h2>팀원 추가</h2>
                    </div>
                </div>
                <%if(channel.members.length > 0) { %>
                    <% for(let member of channel.members) { %>
                        <div class="user__div-wrapper">
                            <img src="<%= member.photo %>">
                            <div class="card">
                                <h2><%= member.name %></h2>
                            </div>
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="user__div-wrapper">
                        <h2>팀원을 초대하세요!!</h2>
                    </div>  
                <% } %>
            </div>
        </div>

        <!-- 유저 초대 클릭시 모달창 오픈 -->
        <div class="invite-container hidden" id="container">
            <div class="invite-modal hidden" id="modal">
                <div class="box__input__invite">
                    <h1>초대할 친구를 찾아보세요.</h1>
                </div>
                <div id="nickname" class="box__input__invite">
                    <input type="text" name="name" id="clientName" placeholder="친구 닉네임을 입력하세요.">
                    <p id="error"></p>
                </div>
                <div class="box__input__invite">
                    <span><button id="search">검색 하기</button></span>
                </div>
                <div class="box__input__invite">
                    <span class="close-modal-button__box"><button id="cancel" class="close-modal-channel">취소</button></span>
                </div>
            </div>
        </div>

        <!-- 검색 후 보일 결과 창 -->
        <div class="invite-container hidden" id="searchBox">
            <div class="invite-modal hidden" id="resultModal">
                <div id="msg"></div>
                <form id="form" method="post">
                    <div class="box__input__invite" id="matchedClientName">
                        <!-- 클라이언트 닉네임 들어갈 곳 -->
                    </div>
                    <div class="box__input__invite" id="photo">
                        <!-- 이미지 들어갈 곳 -->
                    </div>
                    <input type="hidden" name="invitedUserId" id="invitedUserId">
                    <div class="box__input__invite">
                        <span><button type="submit">초대 하기</button></span>
                    </div>
                </form>
                <div class="box__input__invite">
                    <span class="close-modal-button__box"><button id="cancelInvite"
                            class="close-modal-channel">취소</button></span>
                </div>
            </div>
        </div>
                
        <script type="module">
            import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js";

            const socket = io('http://localhost:8080');
            console.log('스크립트 소켓 가동 중!!!');

            const reqApi = async () => {
                try {
                    const name = document.getElementById('clientName').value;
                    const nicknameBox = document.getElementById('nickname');
                    const errorTag = document.getElementById('error');

                    if(name === "") {
                        console.log('비어있습니다.')
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = '함께할 팀원을 입력하세요.'
                        return;
                    }

                    const url = window.location.href;
                    const channelId = url.split('/')[4].split('?')[0];
                    console.log(channelId);
                    console.log(name);
                    const response = await fetch('http://localhost:8080/v1/user/userInfo/' + name, {
                        method: 'POST',
                        headers: {
                            'Content-Type' : 'application/json'
                        },
                        body: JSON.stringify({
                            channelId: channelId
                        })
                    });

                    const data = await response.json();
                    console.log('api응답 data: ', JSON.stringify(data));

                    if (response.status !== 200) {
                        errorTag.style.color = 'red';
                        errorTag.style.fontSize = '13px';
                        errorTag.style.textAlign = 'left';
                        errorTag.textContent = data.error.message;
                    } else {
                        //모달창 오픈
                        document.getElementById('searchBox').classList.remove('hidden');
                        document.getElementById('resultModal').classList.remove('hidden');
                        document.getElementById('container').classList.add('hidden');
                        document.getElementById('modal').classList.add('hidden');

                        const msg = document.getElementById('msg');
                        msg.style.color = 'black';
                        msg.textContent = `${data.user.name}님을 찾았습니다.`;

                        console.log(document.getElementById('matchedClientName'));
                        const h1 = document.createElement('h1');
                        h1.textContent = data.user.name;
                        document.getElementById('matchedClientName').appendChild(h1);

                        const img = document.createElement('img');
                        img.setAttribute('src', data.user.photo);
                        document.getElementById('photo').appendChild(img);

                        const invitedUserId = document.getElementById('invitedUserId');
                        invitedUserId.setAttribute('value', data.user._id);
                        console.log(invitedUserId);

                        const form = document.getElementById('form');
                        const channelId = window.location.href.split('/')[4];
                        console.log('channelId: ', channelId);
                        // 요청 보낼 라우트 세팅
                        form.setAttribute('action', '/client/channel/invite/' + channelId);

                        console.log('프로필 로딩 완료!!!');
                    }
                } catch (err) {
                    console.log(err);
                    throw err;
                }
            }

            document.getElementById('search').addEventListener('click', reqApi);
        </script>
        <%- include('../includes/script.ejs') %>
    </body>
</html>